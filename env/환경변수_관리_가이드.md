# 🔹 환경변수 관리 가이드

> Vite 기반 React 프로젝트에서 환경변수를 중앙에서 관리하고 검증하며, 로깅 기능을 제공하는 `env.js` 유틸리티 사용 방법입니다.

이 문서는 `src/utils/env.js` 파일을 통해 환경변수를 구조화하고, 필수 변수 검증 및 환경별 로깅을 설정하는 방법을 설명합니다. 해커톤 및 공모전(10~14일 시간 제약)에 최적화되었으며, 팀원들이 빠르게 환경변수를 적용하고 디버깅할 수 있도록 설계되었습니다.

## 📌 **오버뷰**

`env.js`는 Vite의 `import.meta.env`를 사용하여 환경변수를 중앙에서 관리하며, 필수 변수 검증(`validateEnv`)과 환경별 로깅(`log` 객체)을 제공합니다. 주요 기능은 다음과 같습니다:

- **환경변수 접근**: API URL, Supabase 키, 기능 플래그, 앱 정보 등을 `env` 객체로 구조화.
- **환경 검출**: 개발(`development`), 프로덕션(`production`), 테스트(`test`) 환경 확인.
- **검증**: 필수 변수(`VITE_API_BASE_URL`, 프로덕션에서 `VITE_SUPABASE_URL` 등)와 타입(`VITE_API_TIMEOUT`) 검증.
- **로깅**: 디버그, 정보, 경고, 에러 로그를 환경에 따라 제어.

**파일 위치**: `src/utils/env.js`

**관련 설정 파일**:

```
project-root/
├── .env                              # 개발 환경변수
├── .env.production                   # 프로덕션 환경변수
├── .env.example                      # 환경변수 템플릿
├── .gitignore                        # 민감 정보 무시
├── vite.config.js                    # Vite 환경변수 접두사 및 프록시 설정
```

## 📚 **설정 및 사용 방법**

### 1. **환경변수 설정 (.env)**

**설명**:  
환경변수는 `.env`, `.env.production`, `.env.example` 파일에 정의하며, `VITE_` 접두사를 사용하여 Vite에서 접근 가능하도록 합니다. `env.js`는 이러한 변수를 구조화하여 안전하게 사용합니다.

```bash
# .env.example
# API 설정
VITE_API_BASE_URL=http://localhost:3000/api
VITE_API_TIMEOUT=10000

# 외부 서비스
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# 기능 플래그
VITE_ENABLE_ANALYTICS=false
VITE_DEBUG_MODE=true

# 앱 정보
VITE_APP_NAME="My Awesome App"
VITE_APP_VERSION="1.0.0"
```

**자세한 적용 방법**:

- **위치**: 프로젝트 루트에 `.env`, `.env.production`, `.env.example` 저장.
- **설치**:
  1. `.env.example`을 참고하여 `.env` 및 `.env.production` 작성.
  2. `.env`는 개발 환경, `.env.production`은 프로덕션 환경에 사용.
- **주의사항**:
  - `.env`와 `.env.production`은 `.gitignore`에 추가하여 민감 정보 보호.
  - `VITE_` 접두사 필수.
  - `.env.example`은 팀원과 공유하며, 민감 정보(예: `VITE_SUPABASE_ANON_KEY`)는 빈 값으로 설정.

### 2. **`env.js` 구조**

**설명**:  
`env.js`는 환경변수를 `env` 객체로 구조화하고, `validateEnv`로 검증하며, `log` 객체로 로깅을 제공합니다.

**코드 구조**:

- **환경변수 접근 (`env`)**:
  - `isDevelopment`, `isProduction`, `isTest`: 현재 환경 확인.
  - `apiBaseUrl`, `apiTimeout`: API 설정.
  - `supabaseUrl`, `supabaseKey`: 외부 서비스(예: Supabase) 설정.
  - `features.enableAnalytics`, `features.enableDebugMode`: 기능 플래그.
  - `appName`, `appVersion`: 앱 정보.
- **검증 함수 (`validateEnv`)**:
  - 필수 변수(`VITE_API_BASE_URL`)와 프로덕션 환경에서 추가 변수(`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`) 확인.
  - `VITE_API_TIMEOUT`의 숫자 타입 검증.
- **로깅 함수 (`log`)**:
  - `debug`: 개발 또는 디버그 모드에서만 출력.
  - `info`, `warn`: 테스트 환경 제외하고 출력.
  - `error`: 항상 출력.

### 3. **사용 예시**

**예시 1: 컴포넌트에서 환경변수 사용**  
`env.js`를 사용하여 API 호출과 앱 정보를 표시합니다.

```jsx
// src/components/AppInfo.jsx
import { env, log, validateEnv } from '@utils/env';

const AppInfo = () => {
  // 환경변수 검증
  try {
    validateEnv();
  } catch (error) {
    log.error(error.message);
    return <div>Error: Invalid environment configuration</div>;
  }

  // API 호출
  const fetchData = async () => {
    log.debug('Fetching data from', env.apiBaseUrl);
    try {
      const response = await fetch(`${env.apiBaseUrl}/info`, {
        timeout: env.apiTimeout,
      });
      const data = await response.json();
      log.info('Data fetched:', data);
    } catch (error) {
      log.error('Fetch failed:', error);
    }
  };

  return (
    <div>
      <h1>
        {env.appName} v{env.appVersion}
      </h1>
      <button onClick={fetchData} disabled={!env.features.enableAnalytics}>
        Fetch Info
      </button>
      {env.isDevelopment && <p>Running in development mode</p>}
    </div>
  );
};

export default AppInfo;
```

**예시 2: Supabase 초기화**  
Supabase 클라이언트를 초기화하고 인증 상태를 확인합니다.

```jsx
// src/services/supabase.js
import { createClient } from '@supabase/supabase-js';
import { env, log, validateEnv } from '@utils/env';

try {
  validateEnv();
} catch (error) {
  log.error(error.message);
  throw error;
}

const supabase = createClient(env.supabaseUrl, env.supabaseKey);

export const checkAuth = async () => {
  log.debug('Checking auth with Supabase:', env.supabaseUrl);
  const { data, error } = await supabase.auth.getSession();
  if (error) {
    log.error('Auth check failed:', error);
    return null;
  }
  return data.session;
};
```

**자세한 적용 방법**:

- **위치**: `src/utils/env.js` 파일을 프로젝트에 추가.
- **설치**: 별도 패키지 설치 불필요 (Vite 기본 제공 `import.meta.env` 사용).
- **사용 시나리오**:
  - `env.apiBaseUrl`: API 호출 시 기본 URL 사용.
  - `validateEnv`: 앱 시작 시 필수 변수 검증.
  - `log.debug`, `log.info`: 디버깅 및 로깅.
  - `env.features`: 기능 플래그로 조건부 렌더링.
- **주의사항**:
  - `validateEnv`를 앱 초기화 시 호출하여 런타임 에러 방지.
  - `log.debug`는 프로덕션에서 출력되지 않도록 `VITE_DEBUG_MODE=false` 설정.
  - `.env.production`에서 `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY` 필수.

### 4. **환경별 설정**

**개발 환경**:

```bash
# .env
VITE_API_BASE_URL=http://localhost:3000/api
VITE_API_TIMEOUT=10000
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_ENABLE_ANALYTICS=false
VITE_DEBUG_MODE=true
VITE_APP_NAME="My Awesome App"
VITE_APP_VERSION="1.0.0"
```

**프로덕션 환경**:

```bash
# .env.production
VITE_API_BASE_URL=https://api.yourservice.com
VITE_API_TIMEOUT=5000
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_ENABLE_ANALYTICS=true
VITE_DEBUG_MODE=false
VITE_APP_NAME="My Awesome App"
VITE_APP_VERSION="1.0.0"
```

**테스트 환경**:

- `VITE_DEBUG_MODE=false`로 설정하여 `log.debug` 비활성화.
- `log.info`, `log.warn`은 테스트 환경에서 출력되지 않음.

### 5. **자주 발생하는 문제**

1. **환경변수 누락**:
   - **문제**: `validateEnv`에서 `VITE_API_BASE_URL` 누락 에러 발생.
   - **해결**:
     - `.env` 또는 `.env.production`에 `VITE_API_BASE_URL` 추가.
     - `.env.example` 참고.
     ```bash
     # 예시
     VITE_API_BASE_URL=http://localhost:3000/api
     ```
2. **잘못된 타입**:
   - **문제**: `VITE_API_TIMEOUT`이 숫자가 아님.
   - **해결**:
     - `.env`에서 숫자 값 설정.
     ```bash
     VITE_API_TIMEOUT=10000
     ```
3. **Supabase 인증 실패**:
   - **문제**: `VITE_SUPABASE_URL` 또는 `VITE_SUPABASE_ANON_KEY` 누락.
   - **해결**:
     - 프로덕션 환경에서 `.env.production`에 추가.
     ```bash
     VITE_SUPABASE_URL=https://your-project.supabase.co
     VITE_SUPABASE_ANON_KEY=your-anon-key
     ```

### 6. **자주 묻는 질문**

**Q1: 환경변수는 어디서 가져오나요?**  
**A**: 환경변수는 `import.meta.env`에서 직접 가져오는 대신, `env.js`의 `env` 객체를 통해 구조화된 방식으로 접근합니다. `validateEnv` 함수로 필수 변수와 타입을 검증하여 런타임 안정성을 보장합니다.

```jsx
// ❌ 직접 접근 (비추천)
const apiUrl = import.meta.env.VITE_API_BASE_URL;
// ✅ env.js 사용
import { env, validateEnv } from '@utils/env';
validateEnv();
const apiUrl = env.apiBaseUrl;
```

**Q2: `.env`와 `.env.production`의 차이는 무엇인가요?**  
**A**: `.env`는 개발 환경(`development`)에서 사용되며, 로컬 서버(예: `http://localhost:3000/api`)와 디버깅 설정(예: `VITE_DEBUG_MODE=true`)을 포함합니다. `.env.production`은 프로덕션 환경(`production`)에서 사용되며, 실제 서버 URL(예: `https://api.yourservice.com`)과 상용 설정(예: `VITE_DEBUG_MODE=false`)을 포함합니다. 주요 차이는 API URL, 타임아웃, 기능 플래그이며, 프로덕션에서는 추가 변수(`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`)가 필수입니다.

**Q3: AWS 배포 시 환경변수만 바꾸면 되나요?**  
**A**: 기본적으로 `.env.production`에 실제 서버 환경에 맞는 변수(예: `VITE_API_BASE_URL=https://api.yourservice.com`)를 설정하면 충분합니다. 하지만 AWS 배포 시 추가로 고려할 점은 다음과 같습니다:

- `Dockerfile`에서 `.env.production`을 복사:
  ```docker
  COPY .env.production .env
  RUN npm run build
  ```
- 또는 AWS ECS/EC2에서 환경변수 직접 주입:
  ```json
  {
    "environment": [
      { "name": "VITE_API_BASE_URL", "value": "https://api.yourservice.com" },
      {
        "name": "VITE_SUPABASE_URL",
        "value": "https://your-project.supabase.co"
      }
    ]
  }
  ```
- 민감 정보(예: `VITE_SUPABASE_ANON_KEY`)는 AWS Secrets Manager로 관리하고 동적으로 주입 권장.
- `validateEnv`를 앱 초기화 시 호출하여 누락된 변수 확인.

**Q4: `.env.example`의 역할은 무엇인가요?**  
**A**: `.env.example`은 팀원이 프로젝트 저장소를 클론한 후 필요한 환경변수 목록과 형식을 알 수 있도록 템플릿 역할을 합니다. 민감 정보는 빈 값으로 제공하며, 팀원은 이를 기반으로 `.env` 또는 `.env.production`을 생성합니다. `.gitignore`에 `!.env.example`을 추가하여 공유합니다.

**Q5: `.gitignore`에서 환경변수 파일을 어떻게 관리하나요?**  
**A**: `.gitignore`에 `.env`, `.env.production`, `.env.*`을 추가하여 API 키(예: `VITE_SUPABASE_ANON_KEY`) 같은 민감 정보가 Git 저장소에 업로드되지 않도록 보호합니다. `.env.example`은 예외로 공유하여 팀원이 참조할 수 있습니다:

```gitignore
.env
.env.*
!.env.example
```

### 7. **체크리스트**

- [ ] `.env`, `.env.production`, `.env.example` 파일 생성.
- [ ] `.gitignore`에 `.env.*`, `!.env.example` 추가.
- [ ] `src/utils/env.js` 파일 추가.
- [ ] 앱 초기화 시 `validateEnv` 호출.
- [ ] `VITE_API_BASE_URL`, `VITE_SUPABASE_URL` 등 필수 변수 설정 확인.
- [ ] `log.debug`가 프로덕션에서 비활성화 확인(`VITE_DEBUG_MODE=false`).

## 📝 **참고: 프로젝트 설정과의 통합**

- **`.gitignore`**: `.env`, `.env.production`, `.env.*` 무시, `.env.example` 공유.
- **Vite**: `vite.config.js`에서 `envPrefix: "VITE_"` 설정, `VITE_API_BASE_URL` 프록시 지원.
  ```jsx
  proxy: {
    "/api": {
      target: env.VITE_API_BASE_URL || "http://localhost:8080",
      changeOrigin: true,
      rewrite: (p) => p.replace(/^\/api/, ""),
    },
  }
  ```
- **ESLint**: `no-console` 규칙은 `log` 객체와 호환, 릴리즈에서 `error`로 설정.
- **Prettier**: 이중따옴표, 세미콜론, 2칸 탭 준수.
- **Docker**: `.env.production` 복사, `.dockerignore`에 `.env.*` 추가.
- **AWS 배포**:
  - `.env.production`을 실제 서버 환경에 맞게 업데이트.
  - AWS ECS/EC2 환경변수 또는 Secrets Manager로 민감 정보 관리.
  - 예:
    ```json
    {
      "secrets": [
        {
          "name": "VITE_SUPABASE_ANON_KEY",
          "valueFrom": "arn:aws:secretsmanager:region:account-id:secret:supabase-key"
        }
      ]
    }
    ```
